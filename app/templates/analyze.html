{% extends "base.html" %}

{% block title %}–ê–Ω–∞–ª–∏–∑ –≤–∏–¥–µ–æ - VideoAnalyzer{% endblock %}

{% block content %}
<div class="analyze-container">
    <div class="analyze-card">
        <h2>–ê–Ω–∞–ª–∏–∑ –≤–∏–¥–µ–æ</h2>
        
        <div class="analyze-form-section">
            <h3>–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ YouTube –≤–∏–¥–µ–æ</h3>
            <form id="analyzeForm" class="analyze-form">
                <div class="form-group">
                    <input type="url" id="video_url" name="video_url" 
                           placeholder="https://www.youtube.com/watch?v=..." required>
                </div>
                <button type="submit" class="btn btn-primary btn-full">–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å</button>
            </form>
        </div>
        
        <div id="loading" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–∏–¥–µ–æ... –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.</p>
        </div>
        
        <div id="results" class="results-section" style="display: none;">
            <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞</h3>
            
            <div id="videoInfo" class="video-info"></div>
            <div id="analysisResult" class="analysis-result"></div>
        </div>
        
        <div id="error" class="error-message" style="display: none;"></div>
    </div>
</div>

<script>
document.getElementById('analyzeForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const videoUrl = document.getElementById('video_url').value;
    const loadingElement = document.getElementById('loading');
    const resultsElement = document.getElementById('results');
    const errorElement = document.getElementById('error');
    
    resultsElement.style.display = 'none';
    errorElement.style.display = 'none';
    loadingElement.style.display = 'block';
    
    try {
        const preferencesResponse = await fetch('/users/{{ current_user.id }}/preferences');
        if (!preferencesResponse.ok) {
            throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        }
        
        const preferences = await preferencesResponse.json();
        
        const response = await fetch('/analyze-video', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                video_url: videoUrl,
                user_preferences: preferences
            })
        });
        
        const result = await response.json();
        
        loadingElement.style.display = 'none';
        
        if (response.ok) {
            displayResults(result);
        } else {
            errorElement.style.display = 'block';
            errorElement.innerHTML = '<div class="error">–û—à–∏–±–∫–∞: ' + result.detail + '</div>';
        }
    } catch (error) {
        loadingElement.style.display = 'none';
        errorElement.style.display = 'block';
        errorElement.innerHTML = '<div class="error">–û—à–∏–±–∫–∞: ' + error.message + '</div>';
    }
});

function displayResults(result) {
    const videoInfoElement = document.getElementById('videoInfo');
    const analysisResultElement = document.getElementById('analysisResult');
    const resultsElement = document.getElementById('results');
    
    // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å fallback –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
    const videoInfo = result.video_info || {};
    const analysis = result.analysis || {};
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    const duration = videoInfo.duration || 0;
    const minutes = Math.floor(duration / 60);
    const seconds = duration % 60;
    const durationFormatted = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–ø–∏—Å–∞–Ω–∏—è
    const description = videoInfo.description || '';
    const shortDescription = description.length > 200 ? 
        description.substring(0, 200) + '...' : description;
    
    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–∏–¥–µ–æ
    videoInfoElement.innerHTML = `
        <div class="video-card">
            <h4>${videoInfo.title || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ'}</h4>
            <p><strong>–ê–≤—Ç–æ—Ä:</strong> ${videoInfo.uploader || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∞–≤—Ç–æ—Ä'}</p>
            <p><strong>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</strong> ${durationFormatted}</p>
            ${videoInfo.view_count ? `<p><strong>–ü—Ä–æ—Å–º–æ—Ç—Ä—ã:</strong> ${videoInfo.view_count.toLocaleString()}</p>` : ''}
            ${description ? `
                <div class="description-section">
                    <strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong>
                    <p class="description-text">${shortDescription}</p>
                    ${description.length > 200 ? '<button class="show-more-btn" onclick="toggleDescription(this)">–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é</button>' : ''}
                    <div class="full-description" style="display: none;">${description}</div>
                </div>
            ` : ''}
        </div>
    `;
    
    // –ê–Ω–∞–ª–∏–∑
    const isSuitable = result.is_suitable || false;
    const matchScore = analysis.match_score || 0;
    const confidence = analysis.confidence || 0;
    const analysisText = analysis.analysis || '–ê–Ω–∞–ª–∏–∑ –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω';
    const reasons = analysis.reasons || [];
    
    const suitabilityClass = isSuitable ? 'suitable' : 'not-suitable';
    
    analysisResultElement.innerHTML = `
        <div class="analysis-card ${suitabilityClass}">
            <div class="suitability-badge">
                ${isSuitable ? '‚úÖ –ü–æ–¥—Ö–æ–¥–∏—Ç' : '‚ùå –ù–µ –ø–æ–¥—Ö–æ–¥–∏—Ç'}
            </div>
            <p><strong>–û—Ü–µ–Ω–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è:</strong> ${matchScore}%</p>
            <p><strong>–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å:</strong> ${Math.round(confidence * 100)}%</p>
            <div class="analysis-text">
                <strong>–ê–Ω–∞–ª–∏–∑:</strong>
                <p>${analysisText}</p>
            </div>
            ${reasons.length > 0 ? `
            <div class="reasons">
                <strong>–ü—Ä–∏—á–∏–Ω—ã:</strong>
                <ul>
                    ${reasons.map(reason => `<li>${reason}</li>`).join('')}
                </ul>
            </div>
            ` : ''}
            ${analysis.detected_topics && analysis.detected_topics.length > 0 ? `
            <div class="topics">
                <strong>–û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ —Ç–µ–º—ã:</strong>
                <div class="topics-list">
                    ${analysis.detected_topics.map(topic => `<span class="topic-tag">${topic}</span>`).join('')}
                </div>
            </div>
            ` : ''}
            ${analysis.content_type ? `
            <div class="content-type">
                <strong>–¢–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞:</strong> ${getContentTypeDisplay(analysis.content_type)}
            </div>
            ` : ''}
        </div>
    `;
    
    resultsElement.style.display = 'block';
}

function getContentTypeDisplay(contentType) {
    const types = {
        'educational': 'üéì –û–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π',
        'entertainment': 'üé≠ –†–∞–∑–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–π',
        'mixed': 'üìö –°–º–µ—à–∞–Ω–Ω—ã–π',
        'unknown': '‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π'
    };
    return types[contentType] || contentType;
}

function toggleDescription(button) {
    const descriptionSection = button.closest('.description-section');
    const shortText = descriptionSection.querySelector('.description-text');
    const fullText = descriptionSection.querySelector('.full-description');
    
    if (fullText.style.display === 'none') {
        shortText.style.display = 'none';
        fullText.style.display = 'block';
        button.textContent = '–°–∫—Ä—ã—Ç—å';
    } else {
        shortText.style.display = 'block';
        fullText.style.display = 'none';
        button.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é';
    }
}
</script>

<style>
.analyze-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
}

.analyze-card {
    background: white;
    border-radius: 10px;
    padding: 30px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.analyze-form-section {
    margin-bottom: 30px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group input {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 16px;
}

.btn-full {
    width: 100%;
}

.loading {
    text-align: center;
    padding: 40px;
}

.spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #007bff;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.results-section {
    margin-top: 30px;
}

.video-card {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    border-left: 4px solid #007bff;
}

.description-section {
    margin-top: 15px;
}

.description-text {
    margin: 8px 0;
    line-height: 1.5;
    color: #555;
}

.full-description {
    margin: 8px 0;
    line-height: 1.5;
    color: #555;
    white-space: pre-wrap;
}

.show-more-btn {
    background: none;
    border: none;
    color: #007bff;
    cursor: pointer;
    font-size: 14px;
    padding: 0;
    margin-top: 5px;
    text-decoration: underline;
}

.show-more-btn:hover {
    color: #0056b3;
}

.analysis-card {
    padding: 20px;
    border-radius: 8px;
    border: 2px solid #ddd;
}

.analysis-card.suitable {
    border-color: #28a745;
    background: #f8fff9;
}

.analysis-card.not-suitable {
    border-color: #dc3545;
    background: #fff8f8;
}

.suitability-badge {
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 15px;
    padding: 10px;
    border-radius: 5px;
    text-align: center;
}

.analysis-card.suitable .suitability-badge {
    background: #d4edda;
    color: #155724;
}

.analysis-card.not-suitable .suitability-badge {
    background: #f8d7da;
    color: #721c24;
}

.analysis-text {
    margin: 15px 0;
    line-height: 1.6;
}

.reasons ul {
    margin: 10px 0;
    padding-left: 20px;
}

.reasons li {
    margin-bottom: 5px;
}

.topics-list {
    margin: 10px 0;
}

.topic-tag {
    display: inline-block;
    background: #e9ecef;
    padding: 4px 8px;
    margin: 2px;
    border-radius: 12px;
    font-size: 12px;
}

.content-type {
    margin-top: 10px;
    font-style: italic;
}

.error-message {
    background: #f8d7da;
    color: #721c24;
    padding: 15px;
    border-radius: 5px;
    margin-top: 20px;
}
</style>
{% endblock %}